---
name: Integration Tests
on:
  # Uncomment to run once per day at 2:00 AM UTC
  # schedule:
  #   - cron: "0 2 * * *"
  workflow_dispatch:  # Allow manual triggering from GitHub UI
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC authentication with AWS
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2  # v2.13.3
        with:
          egress-policy: audit
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502  # v4.0.2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Create integration test config
        run: |
          cat > .env.integration << EOF
          API_KEY=${{ secrets.INTEGRATION_API_KEY }}
          RELAYER_API_KEY=${{ secrets.INTEGRATION_API_KEY }}
          TEST_MODE=ci
          TEST_NETWORKS=${{ secrets.INTEGRATION_TEST_NETWORKS }}
          LOG_LEVEL=info
          AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
          AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
          AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
          AWS_REGION=${{ secrets.AWS_REGION }}
          EOF
      - name: Create relayer config with AWS KMS signer
        run: |
          cat > tests/integration/config/config.json << EOF
          {
            "relayers": [],
            "notifications": [],
            "signers": [
              {
                "id": "aws-kms-signer",
                "type": "aws_kms",
                "config": {
                  "region": "${{ secrets.AWS_REGION }}",
                  "key_id": "${{ secrets.AWS_KMS_KEY_ID }}"
                }
              }
            ],
            "networks": "/app/networks",
            "plugins": []
          }
          EOF
      - name: Run Integration Tests
        run: ./scripts/run-integration-docker.sh
        env:
          TEST_MODE: ci
