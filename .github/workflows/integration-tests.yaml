---
name: Integration Tests
on:
  workflow_dispatch:  # Allow manual triggering from GitHub UI
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC authentication with AWS
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b  # v2.15.0
        with:
          egress-policy: audit
      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
      - name: Set up AWS credentials via OIDC and role chaining
        uses: ./.github/actions/oidc
        with:
          role-for-oidc: ${{ secrets.ROLE_FOR_OIDC_TESTS }}
          role-to-assume: ${{ secrets.ROLE_TO_ASSUME_TESTS }}
          aws-region: ${{ vars.AWS_REGION_KMS_KEY }}
      - name: Create integration test config
        run: |
          cat > .env.integration << EOF
          MODE=testnet
          API_KEY=${{ secrets.INTEGRATION_TESTS_API_KEY }}
          LOG_LEVEL=info
          USE_KMS=true
          CI=true
          AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
          AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
          AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
          AWS_REGION=${{ vars.AWS_REGION_KMS_KEY }}
          EOF
      - name: Inject config files
        env:
          AWS_KMS_REGION: ${{ vars.AWS_REGION_KMS_KEY }}
          AWS_KMS_KEY_ID: ${{ secrets.TESTNET_AWS_KMS_KEY_ID }}
        run: |
          mkdir -p tests/integration/config/testnet
          echo '${{ vars.INTEGRATION_CONFIG_JSON }}' | envsubst > tests/integration/config/testnet/config.json
          echo '${{ vars.INTEGRATION_REGISTRY_JSON }}' > tests/integration/config/testnet/registry.json
      - name: Build Integration Test Image
        run: |
          docker build -f Dockerfile.integration --target runtime -t openzeppelin-relayer-integration:latest .
      - name: Create coverage directories
        run: mkdir -p ./coverage ./profraw
      - name: Run Integration Tests
        run: ./scripts/run-integration-docker.sh
      - name: Verify coverage exists
        if: always()
        run: |
          ls -lah ./coverage/
          if [ -f ./coverage/integration-lcov.info ]; then
            echo "✓ Coverage file found ($(wc -l < ./coverage/integration-lcov.info) lines)"
          else
            echo "✗ Coverage file not found!"
            exit 1
          fi
      # TODO: Integration test coverage will be included in the future when test cases are considerable enough to include
      # - name: Upload Integration Coverage to Codecov
      #   if: always()  # Upload coverage even if tests fail
      #   uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7  # v5.5.1
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     name: integration-coverage
      #     files: ./coverage/integration-lcov.info
      #     flags: integration
      #     fail_ci_if_error: false
      #     verbose: true
