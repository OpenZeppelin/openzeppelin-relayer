---
name: tmp-codecov
on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    paths-ignore:
      - docs/**
      - "**.md"
      - .github/**
      - .gitignore
  push:
    branches:
      - codecove-ai-tests
      - main
    paths-ignore:
      - docs/**
      - "**.md"
      - .github/**
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit
      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: free disk space
        run: |
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt clean
          if [[ $(docker image ls -aq) ]]; then
            docker rmi $(docker image ls -aq)
          else
            echo "No Docker images found to remove"
          fi
      - name: Prepare
        id: init
        uses: ./.github/actions/prepare
        with:
          components: llvm-tools-preview

      - name: Get cache-hit output
        run: 'echo "Cache hit >>>>>: ${{ steps.init.outputs.cache-hit }}"'

      - name: Install cargo hack, cargo-llvm-cov, and grcov
        uses: taiki-e/install-action@a24ba45235ed716ff76646268742990dc9458860 # v2.62.42
        with:
          tool: cargo-hack,cargo-llvm-cov

      - name: Build
        run: cargo test --no-run --locked

      # - name: Run Integration Tests and Generate Coverage Report
      #   env:
      #     LLVM_PROFILE_FILE: integration-%p-%m.profraw
      #     RUSTFLAGS: -Cinstrument-coverage
      #     RUST_TEST_THREADS: 1
      #   run: cargo hack llvm-cov --locked --ignore-filename-regex "(src/api/routes/docs/.*_docs\.rs$|src/repositories/.*/.*_redis\.rs$)" --lcov --output-path integration-lcov.info --test integration

      # - name: Upload Integration Coverage to Codecov
      #   uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7  # v5.5.1
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     name: integration-coverage
      #     files: integration-lcov.info
      #     flags: integration
      #     fail_ci_if_error: true

      - name: Run AI Tests and Generate Coverage Report
        id: ai_coverage
        env:
          LLVM_PROFILE_FILE: ai-%p-%m.profraw
          RUSTFLAGS: -Cinstrument-coverage
          RUST_TEST_THREADS: 1
        timeout-minutes: 45
        run: |
          cargo hack llvm-cov --locked --lib --ignore-filename-regex "(src/api/routes/docs/.*_docs\.rs$|src/repositories/.*/.*_redis\.rs$)" --lcov --output-path ai-lcov.info --tests -- ai_

      - name: Upload AI Coverage to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          name: ai-coverage
          files: ai-lcov.info
          flags: ai
          fail_ci_if_error: true

      - name: Run Developer Tests (excluding AI) and Generate Coverage Report
        id: dev_coverage
        env:
          LLVM_PROFILE_FILE: dev-%p-%m.profraw
          RUSTFLAGS: -Cinstrument-coverage
          RUST_TEST_THREADS: 1
        timeout-minutes: 45
        run: |
          cargo hack llvm-cov --locked --lib --ignore-filename-regex "(src/api/routes/docs/.*_docs\.rs$|src/repositories/.*/.*_redis\.rs$)" --lcov --output-path dev-lcov.info --tests -- --skip ai_

      - name: Upload Developer Coverage to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          name: dev-coverage
          files: dev-lcov.info
          flags: dev
          fail_ci_if_error: true
