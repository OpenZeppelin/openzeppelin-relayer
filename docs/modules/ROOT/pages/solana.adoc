= Solana Integration

== Solana DEX integration

The Relayer can perform automated token‐swaps on Solana using one of two strategies:

* **jupiter-swap** – uses the https://dev.jup.ag/docs/swap-api/[Jupiter Swap API,window="_blank"]  
* **jupiter-ultra** – uses the https://dev.jup.ag/docs/ultra-api/[Jupiter Ultra API,window="_blank"]  

== Configuration

In your relayer’s `policies.swap_config`:

[source,json]
----
"swap_config": {
  "strategy": "jupiter-swap",
  "cron_schedule": "0 0 * * * *",      // every hour on the hour
  "min_balance_threshold": 1_000_000   // lamports
  "jupiter_swap_options": {
    "dynamic_compute_unit_limit": true,
    "priority_level": "high",
    "priority_fee_max_lamports": 1000000000
  }
}
----

* `strategy` (jupiter-swap | jupiter-ultra)  
* `cron_schedule` (string, six‐field cron)  
* `min_balance_threshold` (u64 lamports)
* `jupiter_swap_options`: JupiterSwapOptions


Per token configuration allows setting more granular configuration for swap amounts.

[source,json]
----
"allowed_tokens": [
  {
    "mint": "So111…",
    "swap_config": {
      "min_amount": 10,
      "max_amount": 1000,
      "retain_min_amount": 50
    }
  }
]
----

* `min_amount` (unsigned 64)  
  If the computed swap amount would be less than this, *no* swap occurs for that token.  
* `max_amount` (unsigned 64)  
  The cap on how many token units may be swapped in one job.  
* `retain_min_amount` (unsigned 64)  
  Ensures at least this many tokens remain in the account after the swap.

=== Jupiter Swap Options

You can fine-tune how Jupiter Swap API prioritizes and executes your swap transactions via the
`jupiter_swap_options` object under `policies.swap_config`:

[source,json]
----
"jupiter_swap_options": {
  "dynamic_compute_unit_limit": true,
  "priority_level": "high",
  "priority_fee_max_lamports": 1000000000
}
----

* `dynamic_compute_unit_limit` (boolean)  
  If `true`, the relayer will request a compute-unit limit matching Jupiter’s recommendation  
  (otherwise uses the network default).

* `priority_level` (string)  
  One of `"medium"`, `"high"`, or `"veryHigh"`.  
  Determines how aggressively Jupiter will pay for extra compute units to speed up your swap.

* `priority_fee_max_lamports` (unsigned 64)  
  Caps the maximum lamports you’re willing to pay as a priority fee.  
  Jupiter will never exceed this amount when topping up compute-unit fees.

Note: Refer to the link:https://dev.jup.ag/docs/swap-api/[Jupiter Swap API,window="_blank"] for more info.

== How It Works


The Solana DEX integration operates in two modes:

- **Scheduled Swaps**  
  A background job enqueues `handle_token_swap_request` according to the `cron_schedule` you’ve configured in `policies.swap_config`.  
- **On-Demand Swaps**  
  If any RPC call fails with an `InsufficientFunds` error (e.g. during a transfer or fee estimation), the relayer will automatically invoke the same swap logic before returning the RPC error to the client.

=== Notes

* Only tokens explicitly listed in `allowed_tokens` will ever be swapped.
* Swaps are gated by your chosen fee payment strategy—you must use **user** fees for automated token-swap support.
* Strategies `jupiter-swap` and `jupiter-ultra` are only available on `mainnet-beta`.