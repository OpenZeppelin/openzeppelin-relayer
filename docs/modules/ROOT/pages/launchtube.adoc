= Launchtube
:description: Launchtube plugin for OpenZeppelin Relayer - Simplifies Stellar Soroban transaction submission.

== Overview

Launchtube is a plugin for OpenZeppelin Relayer that simplifies submitting Stellar Soroban transactions by automatically handling the complexity of getting transactions on-chain.

The plugin features:

- **Automatic Fee Bumping**: Uses a dedicated fund account to pay transaction fees
- **Sequence Number Management**: Maintains a pool of sequence accounts for concurrent transaction processing
- **Transaction Simulation**: Automatically simulates and rebuilds transactions with proper resources
- **Retry Logic**: Built-in error handling and retry mechanisms
- **Management API**: Dynamic configuration of sequence accounts

== Using the SDK Client

The recommended way to interact with Launchtube is through the OpenZeppelin Relayer SDK, which provides a type-safe, unified interface for transaction submission and management operations.

=== Installation

[source,bash]
----
npm install @openzeppelin/relayer-sdk
# or
pnpm add @openzeppelin/relayer-sdk
----

=== Client Setup

The SDK supports two connection modes with identical APIs:

[source,typescript]
----
import { LaunchtubeClient, LaunchtubeRelayerClient } from '@openzeppelin/relayer-sdk';

// Direct HTTP connection to Launchtube service
const directClient = new LaunchtubeClient({
  baseUrl: 'https://launchtube.example.com',    // Launchtube service URL
  apiKey: process.env.LAUNCHTUBE_API_KEY,       // Service API key
  adminSecret: process.env.LAUNCHTUBE_ADMIN,    // Optional: for management
  timeout: 30000,                                // Optional: request timeout
});

// Connection via OpenZeppelin Relayer plugin
const relayerClient = new LaunchtubeRelayerClient({
  apiKey: process.env.RELAYER_API_KEY,          // Relayer API key
  pluginId: 'launchtube-plugin',                // Plugin identifier
  baseUrl: 'http://localhost:8080', // Optional: Relayer URL
  adminSecret: process.env.LAUNCHTUBE_ADMIN,    // Optional: for management
});
----

=== Submitting Transactions

[source,typescript]
----
// Submit complete transaction XDR
const result = await client.sendTransaction({
  xdr: 'AAAAAgAAAABQEp+s8xGPrF...',  // Signed transaction envelope
  sim: false,                         // Skip simulation
});

// Submit Soroban function + authorization entries
const result = await client.sendTransaction({
  func: 'AAAABAAAAAEAAAAGc3ltYm9s...',           // Host function XDR
  auth: ['AAAACAAAAAEAAAA...', 'AAAACAAAAAEAAAB...'], // Auth entries
  sim: true,                                          // Simulate first
});

console.log('Transaction:', result.transactionId, result.hash, result.status);
----

=== Managing Sequence Accounts

[source,typescript]
----
// List configured sequence accounts
const accounts = await client.listSequenceAccounts();
console.log('Sequence accounts:', accounts.relayerIds);

// Update sequence accounts (requires adminSecret)
const result = await client.setSequenceAccounts(['seq-001', 'seq-002', 'seq-003']);
console.log('Update successful:', result.ok, result.appliedRelayerIds);
----

=== Example Scripts

Complete working examples are available in the SDK repository:

- https://github.com/OpenZeppelin/openzeppelin-relayer-sdk/blob/main/examples/clients/launchtube-direct-example.ts[launchtube-direct-example.ts] - Direct HTTP connection
- https://github.com/OpenZeppelin/openzeppelin-relayer-sdk/blob/main/examples/clients/launchtube-relayer-example.ts[launchtube-relayer-example.ts] - OpenZeppelin Relayer connection

== Prerequisites

- Node.js >= 18
- pnpm >= 10
- OpenZeppelin Relayer (installed and configured)
- Stellar testnet or mainnet account
- Funded Stellar accounts for the fund and sequence accounts

== Installation

Launchtube can be added to any OpenZeppelin Relayer installation.

**Resources:**

- **npm Package**: https://www.npmjs.com/package/@openzeppelin/relayer-plugin-launchtube[@openzeppelin/relayer-plugin-launchtube]
- **GitHub Repository**: https://github.com/OpenZeppelin/relayer-plugin-launchtube
- **Example Setup**: https://github.com/OpenZeppelin/openzeppelin-relayer/blob/0550c49444be585c6d40c43514758f57604d818b/examples/launchtube-plugin-example[launchtube-plugin-example]

=== Install from npm

[source,bash]
----
# From the root of your Relayer repository
cd plugins
pnpm add @openzeppelin/relayer-plugin-launchtube
----

=== Create the plugin wrapper

Inside your Relayer, create a directory for the plugin and expose its handler:

[source,bash]
----
mkdir -p plugins/launchtube
----

Create `plugins/launchtube/index.ts`:

[source,typescript]
----
export { handler } from '@openzeppelin/relayer-plugin-launchtube';
----

== Configuration

=== Plugin Registration

Register the plugin in your `config/config.json` file:

[source,json]
----
{
  "plugins": [
    {
      "id": "launchtube-plugin",
      "path": "launchtube/index.ts",
      "timeout": 60
    }
  ]
}
----

=== Environment Variables

Configure the required environment variables:

[source,bash]
----
# Required environment variables
export STELLAR_NETWORK="testnet"                              # or "mainnet"
export SOROBAN_RPC_URL="https://soroban-testnet.stellar.org"
export FUND_RELAYER_ID="launchtube-fund"                      # ID of the fund relayer
export LAUNCHTUBE_ADMIN_SECRET="your-secret-here"             # Required for management API

# Optional environment variables
export LOCK_TTL_SECONDS=30                                    # Lock timeout (default: 30, range: 10-30)
----

**Required Variables:**

- `STELLAR_NETWORK`: Either "testnet" or "mainnet"
- `SOROBAN_RPC_URL`: Stellar Soroban RPC endpoint URL
- `FUND_RELAYER_ID`: Relayer ID for the account that pays transaction fees

**Optional Variables:**

- `LAUNCHTUBE_ADMIN_SECRET`: Secret for accessing the management API (required to manage sequence accounts)
- `LOCK_TTL_SECONDS`: TTL for sequence account locks in seconds (default: 30, range: 10-30)

=== Relayer Configuration

Launchtube requires two types of relayers:

1. **Fund Account**: The account that pays transaction fees (should have `concurrent_transactions: true` enabled)
2. **Sequence Accounts**: At least one sequence account (recommended: 2 or more for better throughput)

Configure relayers in your `config/config.json`:

[source,json]
----
{
  "relayers": [
    {
      "id": "launchtube-fund",
      "chain": "stellar",
      "signer": "launchtube-fund-signer",
      "policies": {
        "concurrent_transactions": true
      }
    },
    {
      "id": "launchtube-seq-001",
      "chain": "stellar",
      "signer": "launchtube-seq-001-signer"
    },
    {
      "id": "launchtube-seq-002",
      "chain": "stellar",
      "signer": "launchtube-seq-002-signer"
    }
  ]
}
----

NOTE: The fund relayer should have `concurrent_transactions: true` enabled to allow parallel transaction processing.

After configuration, fund these accounts on-chain and register them with Launchtube (see "Initializing Sequence Accounts" below).

== Initializing Sequence Accounts

After configuring your relayers in `config.json` and funding the Stellar accounts, register them with Launchtube via the Management API:

[source,bash]
----
curl -X POST http://localhost:8080/api/v1/plugins/launchtube-plugin/call \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "management": {
        "action": "setSequenceAccounts",
        "adminSecret": "your-secret-here",
        "relayerIds": ["launchtube-seq-001", "launchtube-seq-002"]
      }
    }
  }'
----

**Response:**

[source,json]
----
{
  "success": true,
  "data": {
    "appliedRelayerIds": ["launchtube-seq-001", "launchtube-seq-002"]
  },
  "error": null
}
----

This tells Launchtube which relayers to use as sequence accounts. All relayer IDs must match your configured relayer IDs in `config.json`.

Launchtube is now ready to serve Soroban transactions.

== Automated Setup

To skip the manual configuration steps, use the provided automation script. It automates the entire setup process: creating signers and relayers via the API, funding accounts on-chain, and registering them with Launchtube.

=== Prerequisites

When using the automated setup, you only need to configure and fund the **fund account**:

[source,json]
----
{
  "relayers": [
    {
      "id": "launchtube-fund",
      "chain": "stellar",
      "signer": "launchtube-fund-signer",
      "policies": {
        "concurrent_transactions": true
      }
    }
  ]
}
----

The script creates all sequence account signers and relayers dynamically - no config.json entries needed for sequence accounts.

=== Running the Script

[source,bash]
----
pnpm exec tsx ./scripts/create-sequence-accounts.ts \
  --total 3 \
  --base-url http://localhost:8080 \
  --api-key <RELAYER_API_KEY> \
  --funding-relayer launchtube-fund \
  --plugin-id launchtube-plugin \
  --plugin-admin-secret <LAUNCHTUBE_ADMIN_SECRET> \
  --network testnet
----

=== What the Script Does

1. **Creates sequence account signers and relayers via API**: Following the naming pattern `lt-seq-0001`, `lt-seq-0002`, etc.
2. **Funds sequence accounts on-chain**: Submits funding transactions through the fund relayer and waits for confirmation
3. **Registers with Launchtube**: Automatically calls the Management API to register all sequence accounts

=== Script Options

- `--total`: Number of sequence accounts to create (recommended: 2-3 for testing, more for production)
- `--fix`: Audit and heal partially created state (use if the script was interrupted)
- `--dry-run`: Preview actions without making changes
- `--prefix`: Customize the naming prefix (default: `lt-seq-`)
- `--starting-balance`: XLM amount for each account (default: 5)

=== Script Location

- Example directory: https://github.com/OpenZeppelin/relayer-plugin-launchtube/blob/main/scripts/create-sequence-accounts.ts[`scripts/create-sequence-accounts.ts`]


== API Usage

Launchtube is invoked by making POST requests to the plugin endpoint:

[source,bash]
----
POST /api/v1/plugins/{plugin-id}/call
----

=== Submitting Transactions

There are two ways to submit transactions to Launchtube:

==== Option 1: Complete Transaction XDR

Submit a complete, signed transaction envelope:

[source,bash]
----
curl -X POST http://localhost:8080/api/v1/plugins/launchtube-plugin/call \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "xdr": "AAAAAgAAAAA...",
      "sim": false
    }
  }'
----

==== Option 2: Soroban Function + Auth

Submit just the Soroban function and authorization entries:

[source,bash]
----
curl -X POST http://localhost:8080/api/v1/plugins/launchtube-plugin/call \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "func": "AAAABAAAAAEAAAAGc3ltYm9s...",
      "auth": ["AAAACAAAAAEAAAA..."],
      "sim": true
    }
  }'
----

=== Parameters

- `xdr` (string): Complete transaction envelope XDR (base64)
- `func` (string): Soroban host function XDR (base64)
- `auth` (array of strings): Array of Soroban authorization entry XDRs (base64)
- `sim` (boolean): Whether to simulate the transaction before submission

**Important Notes:**

- Provide either `xdr` OR `func`+`auth`, not both
- When using `sim: true`, Launchtube will simulate the transaction and rebuild it with proper resource limits
- When using `sim: false` with `xdr`, you must provide a pre-assembled transaction with resource fees

=== Generating XDR with Stellar SDK

Use the `@stellar/stellar-sdk` to generate the required XDR values:

==== Full Transaction Envelope XDR

[source,typescript]
----
import { Networks, TransactionBuilder, rpc } from '@stellar/stellar-sdk';

// Build your transaction
const tx = new TransactionBuilder(account, {
  fee: '100',
  networkPassphrase: Networks.TESTNET,
})
  .addOperation(/* Operation.invokeHostFunction from Contract.call(...) */)
  .setTimeout(30)
  .build();

// Optional: pre-simulate to set resources/fees before signing
const sim = await rpcServer.simulateTransaction(tx);
const prepared = rpc.assembleTransaction(tx, sim).build();
prepared.sign(keypair);

// Export base64 envelope XDR
const envelopeXdr = prepared.toXDR();
----

==== Soroban Function + Auth XDRs

[source,typescript]
----
// Build and simulate first to obtain auth
const baseTx = /* TransactionBuilder(...).addOperation(...).build() */;
const sim = await rpcServer.simulateTransaction(baseTx);

// Apply simulation, then extract from the InvokeHostFunction operation
const assembled = rpc.assembleTransaction(baseTx, sim).build();
const op = assembled.operations[0]; // Operation.InvokeHostFunction

const funcXdr = op.func.toXDR("base64");
const authXdrs = (op.auth ?? []).map(a => a.toXDR("base64"));
----

== Management API

Launchtube provides a management API to dynamically configure sequence accounts. This API requires authentication via the `LAUNCHTUBE_ADMIN_SECRET` environment variable.

=== List Sequence Accounts

Get the current list of configured sequence accounts:

[source,bash]
----
curl -X POST http://localhost:8080/api/v1/plugins/launchtube-plugin/call \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "management": {
        "action": "listSequenceAccounts",
        "adminSecret": "your-secret-here"
      }
    }
  }'
----

**Response:**

[source,json]
----
{
  "success": true,
  "data": {
    "relayerIds": ["launchtube-seq-001", "launchtube-seq-002"]
  },
  "error": null
}
----

=== Set Sequence Accounts

Configure the sequence accounts that Launchtube will use. This replaces the entire list:

[source,bash]
----
curl -X POST http://localhost:8080/api/v1/plugins/launchtube-plugin/call \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "management": {
        "action": "setSequenceAccounts",
        "adminSecret": "your-secret-here",
        "relayerIds": ["launchtube-seq-001", "launchtube-seq-002", "launchtube-seq-003"]
      }
    }
  }'
----

**Response:**

[source,json]
----
{
  "success": true,
  "data": {
    "appliedRelayerIds": ["launchtube-seq-001", "launchtube-seq-002", "launchtube-seq-003"]
  },
  "error": null
}
----

**Important Notes:**

- You must configure at least one sequence account before Launchtube can process transactions
- The management API will prevent removing accounts that are currently locked (in use). On failure it returns HTTP 409 with code `LOCKED_CONFLICT` and `details.locked` listing the blocked IDs
- All relayer IDs must exist in your OpenZeppelin Relayer configuration
- The `adminSecret` must match the `LAUNCHTUBE_ADMIN_SECRET` environment variable

== Responses

All API responses use the standard Relayer envelope format: `{ success, data, error, metadata }`.

=== Success Response (HTTP 200)

[source,json]
----
{
  "success": true,
  "data": {
    "transactionId": "tx_123456",
    "hash": "1234567890abcdef..."
  },
  "error": null
}
----

**Response Fields:**

- `success`: `true` when the plugin executed successfully
- `data`: Contains the transaction result
  - `transactionId`: The OpenZeppelin Relayer transaction ID
  - `hash`: The Stellar transaction hash
- `error`: `null` on success

=== Error Response (HTTP 4xx)

[source,json]
----
{
  "success": false,
  "data": {
    "code": "INVALID_PARAMS",
    "details": { "sim": false, "xdrProvided": false }
  },
  "error": "Cannot pass `sim = false` without `xdr`",
  "metadata": {
    "logs": [
      { "level": "error", "message": "Cannot pass `sim = false` without `xdr`" }
    ]
  }
}
----

**Error Response Fields:**

- `success`: `false` when the plugin encountered an error
- `data`: Contains error details
  - `code`: Error code (e.g., "INVALID_PARAMS", "LOCKED_CONFLICT")
  - `details`: Additional context about the error
- `error`: Human-readable error message
- `metadata.logs`: Plugin execution logs (if `emit_logs` is enabled)

=== Common Error Codes

- `INVALID_PARAMS`: Invalid parameter combination provided
- `LOCKED_CONFLICT`: Attempting to remove sequence accounts that are currently in use
- `MISSING_PARAM`: Required parameter is missing
- `AUTH_FAILED`: Authentication failed (invalid admin secret)

== How It Works

Launchtube processes transactions through the following workflow:

1. **Request Validation**: Validates input parameters and extracts Soroban data from XDR or func+auth
2. **Sequence Account Acquisition**: Acquires an available sequence account from the pool using Redis locks
3. **Authorization Checking**: Validates authorization entries and determines if simulation is possible
4. **Simulation** (if enabled): Simulates the transaction and rebuilds it with proper resource limits and fees
5. **Fee Bumping**: Fund account wraps the transaction in a fee bump envelope
6. **Submission**: Sends the transaction to the Stellar network via the Soroban RPC
7. **Confirmation**: Returns the transaction ID and hash for tracking

This architecture enables:

- **Concurrent Processing**: Multiple transactions can be processed in parallel using different sequence accounts
- **Automatic Resource Management**: Simulation ensures transactions have sufficient resources
- **Simplified User Experience**: Users don't need to manage sequence numbers or fee bumping

== Example Setup

For a complete working example with Docker Compose, refer to the Launchtube plugin example in the OpenZeppelin Relayer repository:

- **Location**: https://github.com/OpenZeppelin/openzeppelin-relayer/blob/0550c49444be585c6d40c43514758f57604d818b/examples/launchtube-plugin-example[examples/launchtube-plugin-example]
- **Documentation**: https://github.com/OpenZeppelin/openzeppelin-relayer/blob/0550c49444be585c6d40c43514758f57604d818b/examples/launchtube-plugin-example/README.md[README.md]

The example includes:

- Pre-configured Docker Compose setup
- Scripts for creating and funding accounts
- Complete configuration files
- Step-by-step setup instructions
- Local plugin development workflow

== Additional Resources

- **Stellar SDK Documentation**: https://stellar.github.io/js-stellar-sdk/
- **Soroban Documentation**: https://soroban.stellar.org/docs
