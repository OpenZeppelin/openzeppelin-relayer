= Midnight Integration

:description: Comprehensive guide for using OpenZeppelin Relayer with Midnight networks, including configuration, privacy-preserving features, API usage, and zero-knowledge proof support.

== Overview

OpenZeppelin Relayer provides comprehensive support for Midnight blockchain networks, enabling secure transaction relaying with privacy-preserving features through zero-knowledge proofs.

NOTE: Midnight support is currently under active development. The API interactions and specifics described below may evolve.

== Features

- Privacy-preserving transaction processing using zero-knowledge proofs
- Support for guaranteed offers, intents, and fallible offers
- Integration with Midnight's indexer and prover infrastructure
- Transaction status monitoring and state synchronization
- Custom RPC endpoints and network policies

== Supported Networks

Midnight networks are defined via JSON configuration files, providing flexibility to:

- Configure Midnight testnet environments
- Set up custom Midnight-compatible networks with specific RPC endpoints
- Define indexer URLs for transaction monitoring
- Configure prover URLs for zero-knowledge proof generation

Example Midnight network configuration:

[source,json]
----
{
  "networks": [
    {
      "type": "midnight",
      "network": "testnet",
      "rpc_urls": ["http://localhost:9944"],
      "explorer_urls": ["https://explorer.midnight.network"],
      "average_blocktime_ms": 5000,
      "is_testnet": true,
      "indexer_urls": {
        "http": "https://indexer.midnight.network",
        "ws": "wss://indexer.midnight.network"
      },
      "prover_url": "https://prover.midnight.network",
      "commitment_tree_ttl": 3600,
      "tags": ["midnight", "testnet", "privacy"]
    }
  ]
}
----

=== Network-Specific Configuration

Midnight networks require additional configuration beyond standard network settings:

[cols="1,1,1,2"]
|===
|Field |Type |Required |Description

|`indexer_urls`
|object
|Yes
|URLs for the indexer service with `http` and `ws` endpoints for monitoring blockchain state

|`prover_url`
|string
|Yes
|URL for the prover service that generates zero-knowledge proofs

|`commitment_tree_ttl`
|integer
|No
|Time-to-live in seconds for caching Merkle roots (default: 3600)
|===

For detailed network configuration options, see the xref:network_configuration.adoc[Network Configuration] guide.

== Supported Signers

- `local` (local keystore files)
- `vault` (HashiCorp Vault secret storage)
- `turnkey` (hosted Turnkey signer)
- `google_cloud_kms` (Google Cloud KMS)
- `aws_kms` (Amazon AWS KMS)

[NOTE]
====
In production systems, hosted signers (AWS KMS, Google Cloud KMS, Turnkey) are recommended for the best security model.
====

== Quickstart

For a step-by-step setup, see xref:quickstart.adoc[Quick Start Guide].
Key prerequisites:

- Rust 2021, version `1.86` or later
- Redis
- Docker (required for prover server)
- Access to Midnight testnet

=== Starting the Prover Server

Midnight requires a prover server for generating zero-knowledge proofs. Start it using Docker:

[source,bash]
----
docker run -p 6300:6300 midnightnetwork/proof-server -- 'midnight-proof-server --network testnet'
----

This will start the prover server on port 6300, which should match the `prover_url` in your network configuration.

Example configuration for a Midnight relayer:
[source,json]
----
{
  "id": "midnight-testnet-example",
  "name": "Midnight Testnet Example",
  "network": "testnet",
  "paused": false,
  "notification_id": "notification-example",
  "signer_id": "local-signer",
  "network_type": "midnight"
}
----

For more configuration examples, visit the link:https://github.com/OpenZeppelin/openzeppelin-relayer/tree/main/examples[OpenZeppelin Relayer examples repository, window=_blank].

== Configuration

=== Relayer Policies

Midnight relayers support standard relayer configuration options along with Midnight-specific policies:

[cols="1,1,1,2"]
|===
|Policy |Type |Default |Description

|`min_balance`
|integer
|0
|Minimum balance in speck (smallest unit) required for the relayer account to operate
|===

Example configuration with policies:
[source,json]
----
{
  "id": "midnight-example",
  "name": "Midnight Example",
  "network": "testnet",
  "paused": false,
  "network_type": "midnight",
  "signer_id": "local-signer",
  "policies": {
    "min_balance": 1000000000
  }
}
----

For general relayer configuration options, check xref:index.adoc#3_relayers[User Documentation - Relayers].

== API Reference

The Midnight API provides transaction management capabilities with privacy features.

Common endpoints:

- `POST /api/v1/relayers/<relayer_id>/transactions` - Submit a transaction
- `GET /api/v1/relayers/<relayer_id>/transactions` - List transactions
- `GET /api/v1/relayers/<relayer_id>/transactions/<transaction_id>` - Get transaction by ID
- `GET /api/v1/relayers/<relayer_id>/balance` - Get relayer balance

=== Transaction Structure

Midnight transactions consist of three main components and an optional TTL:

[cols="1,2"]
|===
|Component |Description

|`guaranteed_offer`
|Transfers that must succeed atomically. Used for simple value transfers between addresses.

|`intents`
|Complex contract interactions that may involve multiple steps or conditions with segment IDs.

|`fallible_offers`
|Operations that may fail independently without affecting other parts of the transaction. Each has a segment ID.

|`ttl`
|Optional time-to-live as ISO 8601 timestamp. If not provided, uses default expiration.
|===

=== Submit Transaction

Example of a simple value transfer:

[source,bash]
----
curl --location --request POST 'http://localhost:8080/api/v1/relayers/<midnight_relayer_id>/transactions' \
--header 'Authorization: Bearer <api_key>' \
--header 'Content-Type: application/json' \
--data-raw '{
  "guaranteed_offer": {
    "inputs": [
      {
        "origin": "<sender_wallet_seed>",
        "token_type": "02000000000000000000000000000000000000000000000000000000000000000000",
        "value": "1000000"
      }
    ],
    "outputs": [
      {
        "destination": "<recipient_wallet_seed>",
        "token_type": "02000000000000000000000000000000000000000000000000000000000000000000",
        "value": "1000000"
      }
    ]
  },
  "intents": [],
  "fallible_offers": [],
  "ttl": "2025-12-31T23:59:59Z"
}'
----

NOTE: The `ttl` field is optional. If provided, it should be an ISO 8601 formatted timestamp.

=== Transaction Fields

[cols="1,1,2"]
|===
|Field |Type |Description

|`origin`
|string
|Hex-encoded wallet seed of the sender (32 bytes)

|`destination`
|string
|Hex-encoded wallet seed of the recipient (32 bytes)

|`token_type`
|string
|Token identifier (tDUST = "02" followed by zeros for testnet)

|`value`
|string
|Amount in smallest units (speck, where 1 tDUST = 10^9 speck)
|===

=== Get Transaction Status

[source,bash]
----
curl --location --request GET 'http://localhost:8080/api/v1/relayers/<midnight_relayer_id>/transactions/<transaction_id>' \
--header 'Authorization: Bearer <api_key>'
----

Response example:
[source,json]
----
{
  "success": true,
  "data": {
    "id": "a6a468d1-3e87-48fe-9183-e44a9cb92be7",
    "hash": null,
    "pallet_hash": null,
    "block_hash": null,
    "status": "pending",
    "created_at": "2025-08-20T19:11:23.868603+00:00",
    "sent_at": null,
    "confirmed_at": null
  },
  "error": null
}
----

=== Transaction Status Values

- `pending`: Transaction is queued for processing
- `confirmed`: Transaction has been confirmed on the network
- `failed`: Transaction failed to process

=== Get Balance

[source,bash]
----
curl --location --request GET 'http://localhost:8080/api/v1/relayers/<midnight_relayer_id>/balance' \
--header 'Authorization: Bearer <api_key>'
----

Response example:
[source,json]
----
{
  "success": true,
  "data": {
    "balance": 1000000000,
    "unit": "speck"
  },
  "error": null
}
----

See link:https://release-v1-0-0%2D%2Dopenzeppelin-relayer.netlify.app/api_docs.html[API Reference^] for full details and examples.

== Privacy Features

=== Zero-Knowledge Proofs

Midnight uses zero-knowledge proofs to enable privacy-preserving transactions:

- **Private State**: User balances and transaction details remain confidential
- **Public Verifiability**: Network validators can verify transaction validity without seeing details
- **Selective Disclosure**: Users can choose what information to reveal

=== Commitment Trees

The relayer manages Merkle commitment trees for efficient proof generation:

- Caches commitment roots based on `commitment_tree_ttl` configuration
- Automatically synchronizes with the blockchain state
- Optimizes proof generation performance

== Transaction Lifecycle

=== 1. Transaction Creation
- Construct transaction with guaranteed offers, intents, or fallible offers
- Specify input and output tokens with amounts
- Define privacy requirements

=== 2. Proof Generation
- Transaction data is sent to the prover service
- Zero-knowledge proofs are generated for privacy preservation
- Proofs are attached to the transaction

=== 3. Transaction Submission
- Signed transaction with proofs is submitted to the network
- Transaction enters the mempool for processing

=== 4. Transaction Processing
- Network validators verify the zero-knowledge proofs
- Transaction is included in a block if valid
- State updates are applied while maintaining privacy

=== 5. Confirmation
- Transaction is confirmed after block finalization
- Indexer service updates transaction status
- Notifications are sent if configured

== Security Best Practices

=== Network Security
- Use secure connections (HTTPS/WSS) for all network communication
- Configure appropriate `max_fee` to prevent excessive transaction costs
- Monitor relayer balance and set appropriate `min_balance`
- Regularly rotate wallet seeds in test environments

=== Privacy Considerations
- Never expose wallet seeds in logs or error messages
- Use secure key management for production deployments
- Implement proper access controls for relayer endpoints
- Audit transaction patterns to prevent privacy leaks

=== Operational Security
- Deploy behind a secure reverse proxy
- Use HTTPS for all API communications
- Implement proper rate limiting
- Monitor for unusual transaction patterns
- Keep prover and indexer URLs secure

== Monitoring and Observability

Enable metrics and monitor:

- Transaction success rates
- Proof generation times
- Network synchronization status
- Relayer balance levels
- Failed transaction patterns
- Indexer connectivity
- Prover service availability

== Troubleshooting

Common issues and solutions:

=== Connection Issues
- Verify indexer URLs (both HTTP and WebSocket) are accessible
- Check prover service availability
- Ensure network RPC endpoints are responsive

=== Transaction Failures
- Verify wallet seeds are correctly formatted (32-byte hex strings)
- Check token types match network configuration
- Ensure sufficient balance for transaction and fees
- Review commitment tree synchronization status

=== Performance Issues
- Adjust `commitment_tree_ttl` for optimal caching
- Monitor prover service response times
- Check network latency to RPC endpoints

== Support

For help with Midnight integration:

- Join our link:https://t.me/openzeppelin_tg/2[Telegram] community
- Open an issue on our link:https://github.com/OpenZeppelin/openzeppelin-relayer[GitHub repository]
- Check our link:https://docs.openzeppelin.com/relayer[comprehensive documentation]
- Visit the link:https://midnight.network[Midnight Network documentation] for protocol-specific details

== License

This project is licensed under the GNU Affero General Public License v3.0.
